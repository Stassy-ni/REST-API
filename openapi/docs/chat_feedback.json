{
  "openapi": "3.0.3",
  "info": {
    "title": "Math Learning Platform API",
    "version": "1.0.0",
    "description": "Спецификация REST API для модуля Обратной связи."
  },
  "servers": [
    {
      "url": "https://api.mathplatform.example.com/v1",
      "description": "Production"
    }
  ],
  "tags": [
    { "name": "Feedback - Обратная связь", "description": "Отзывы и предложения от пользователей" },
    { "name": "Support Chat", "description": "Диалоговая поддержка для пользователей и админов" },
    { "name": "Chat - Классные чаты", "description": "Чаты учителя с классами" }
  ],
  "externalDocs": {
    "description": "Swagger UI / Redoc",
    "url": "https://api.mathplatform.example.com/docs"
  },
  "paths": {
    "/feedback": {
      "post": {
        "tags": ["Feedback - Обратная связь"],
        "summary": "Оставить отзыв или предложение",
        "security": [{ "BearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/Feedback.Create" },
              "example": {
                "text": "Было бы удобно добавить ночной режим.",
                "email_at_time": "student@example.com",
                "fio_at_time": "Иван Иванов"
              }
            }
          }
        },
        "responses": {
          "201": { "description": "Отзыв отправлен" },
          "400": { "description": "Ошибка валидации" }
        }
      }
    },
    "/admin/feedback": {
      "get": {
        "tags": ["Feedback - Обратная связь"],
        "summary": "Просмотр всех отзывов (админ)",
        "security": [{ "BearerAuth": [] }],
        "parameters": [
          { "name": "email", "in": "query", "schema": { "type": "string" } },
          { "name": "created_after", "in": "query", "schema": { "type": "string", "format": "date-time" } },
          { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 20 } },
          { "name": "offset", "in": "query", "schema": { "type": "integer", "default": 0 } }
        ],
        "responses": {
          "200": {
            "description": "Список отзывов",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "count": { "type": "integer" },
                    "next": { "type": "string", "format": "uri", "nullable": true },
                    "previous": { "type": "string", "format": "uri", "nullable": true },
                    "results": { "type": "array", "items": { "$ref": "#/components/schemas/Feedback.Entry" } }
                  }
                }
              }
            }
          },
          "403": { "description": "Только для админов" }
        }
      }
    },
    "/support-chats": {
      "post": {
        "tags": ["Support Chat"],
        "summary": "Создать новую поддержку (ticket)",
        "security": [{ "BearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/SupportChat.TicketCreate" },
              "example": {
                "subject": "Ошибка отправки задания",
                "initial_message": "Не могу отправить решение, ошибка 500.",
                "reply_by_email": false
              }
            }
          }
        },
        "responses": {
          "201": { "description": "Тикет создан" },
          "400": { "description": "Ошибка валидации" }
        }
      }
    },
    "/support-chats/messages": {
      "get": {
        "tags": ["Support Chat"],
        "summary": "Получить все сообщения (все тикеты)",
        "security": [{ "BearerAuth": [] }],
        "parameters": [
          { "name": "chat_id", "in": "query", "schema": { "type": "integer" }, "required": true },
          { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 20 } },
          { "name": "offset", "in": "query", "schema": { "type": "integer", "default": 0 } }
        ],
        "responses": {
          "200": {
            "description": "Сообщения тикета",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "count": { "type": "integer" },
                    "next": { "type": "string", "format": "uri", "nullable": true },
                    "previous": { "type": "string", "format": "uri", "nullable": true },
                    "results": { "type": "array", "items": { "$ref": "#/components/schemas/SupportChat.Message" } }
                  }
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["Support Chat"],
        "summary": "Отправить сообщение в тикет",
        "security": [{ "BearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/SupportChat.MessageCreate" },
              "example": { "chat_id": 12, "content": "Пожалуйста, уточните, что произошло." }
            }
          }
        },
        "responses": {
          "201": { "description": "Сообщение отправлено" },
          "400": { "description": "Ошибка валидации" }
        }
      }
    },
    "/support-chats/{chat_id}": {
      "get": {
        "tags": ["Support Chat"],
        "summary": "Получить информацию о конкретном чате (ticket)",
        "security": [{ "BearerAuth": [] }],
        "parameters": [
          { "name": "chat_id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": {
          "200": {
            "description": "Данные по чату",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/SupportChat.TicketDetail" }
              }
            }
          },
          "403": { "description": "Нет прав доступа" },
          "404": { "description": "Чат не найден" }
        }
      },
      "patch": {
        "summary": "Закрыть чат",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "status": { "type": "string", "enum": ["closed"] }
                }
              }
            }
          }
        }
      }
    },
    "/support-chats/{chat_id}/messages": {
      "get": {
        "tags": ["Support Chat"],
        "summary": "Получить сообщения чата с поддержкой",
        "security": [{ "BearerAuth": [] }],
        "parameters": [
          { "name": "chat_id", "in": "path", "required": true, "schema": { "type": "integer" } },
          { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 20 } },
          { "name": "offset", "in": "query", "schema": { "type": "integer", "default": 0 } }
        ],
        "responses": {
          "200": {
            "description": "Сообщения чат-тинка",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "count": { "type": "integer" },
                    "next": { "type": "string", "format": "uri", "nullable": true },
                    "previous": { "type": "string", "format": "uri", "nullable": true },
                    "results": { "type": "array", "items": { "$ref": "#/components/schemas/SupportChat.Message" } }
                  }
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["Support Chat"],
        "summary": "Отправить сообщение в чат (ticket)",
        "security": [{ "BearerAuth": [] }],
        "parameters": [
          { "name": "chat_id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/SupportChat.MessageCreate" },
              "example": { "content": "Дополнительная информация: вот ссылка..." }
            }
          }
        },
        "responses": {
          "201": { "description": "Сообщение отправлено" },
          "400": { "description": "Ошибка валидации" },
          "403": { "description": "Нет прав доступа" }
        }
      }
    },
    "/class-chats": {
      "get": {
        "tags": ["Chat - Классные чаты"],
        "summary": "Получить список чатов по классам учителя",
        "security": [ { "BearerAuth": [] } ],
        "responses": {
          "200": {
            "description": "Список чатов",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/Chat.Chat" }
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["Chat - Классные чаты"],
        "summary": "Создать чат для класса",
        "security": [ { "BearerAuth": [] } ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/Chat.ChatCreate" },
              "example": { "class_id": 7 }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Чат создан",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Chat.Chat" }
              }
            }
          },
          "400": { "description": "Ошибка валидации или чат уже существует" }
        }
      }
    },
    "/class-chats/{chat_id}": {
      "get": {
        "tags": ["Chat - Классные чаты"],
        "summary": "Получить информацию о чате",
        "security": [ { "BearerAuth": [] } ],
        "parameters": [
          { "name": "chat_id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": {
          "200": {
            "description": "Информация о чате",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Chat.Chat" }
              }
            }
          },
          "404": { "description": "Чат не найден" }
        }
      }
    },
    "/class-chats/{chat_id}/messages": {
      "get": {
        "tags": ["Chat - Классные чаты"],
        "summary": "Получить сообщения чата",
        "security": [ { "BearerAuth": [] } ],
        "parameters": [
          { "name": "chat_id", "in": "path", "required": true, "schema": { "type": "integer" } },
          { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 20 } },
          { "name": "offset", "in": "query", "schema": { "type": "integer", "default": 0 } }
        ],
        "responses": {
          "200": {
            "description": "Список сообщений",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "count": { "type": "integer" },
                    "next": { "type": "string", "format": "uri", "nullable": true },
                    "previous": { "type": "string", "format": "uri", "nullable": true },
                    "results": { "type": "array", "items": { "$ref": "#/components/schemas/Chat.Message" } }
                  }
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["Chat - Классные чаты"],
        "summary": "Отправить сообщение в чат",
        "security": [ { "BearerAuth": [] } ],
        "parameters": [
          { "name": "chat_id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/Chat.MessageCreate" },
              "example": { "content": "Здравствуйте, напомните о домашней работе." }
            }
          }
        },
        "responses": {
          "201": { "description": "Сообщение отправлено" },
          "400": { "description": "Ошибка валидации" }
        }
      }
    },
    "/class-chat-messages/{message_id}": {
      "delete": {
        "tags": ["Chat - Классные чаты"],
        "summary": "Удалить своё сообщение",
        "security": [ { "BearerAuth": [] } ],
        "parameters": [
          { "name": "message_id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": {
          "204": { "description": "Сообщение удалено" },
          "403": { "description": "Попытка удалить чужое сообщение" },
          "404": { "description": "Сообщение не найдено" }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "BearerAuth": { "type": "http", "scheme": "bearer", "bearerFormat": "JWT" }
    },
    "schemas": {
      "Feedback.Create": {"type":"object","required":["text"],"properties":{"text":{"type":"string"},"email_at_time":{"type":"string","format":"email"},"fio_at_time":{"type":"string"}}},
      "Feedback.Entry": {"type":"object","properties":{"id":{"type":"integer"},"user_id":{"type":"integer"},"text":{"type":"string"},"email_at_time":{"type":"string","format":"email"},"fio_at_time":{"type":"string"},"created_at":{"type":"string","format":"date-time"}}},
      "SupportChat.TicketCreate": {"type":"object","required":["subject","initial_message"],"properties":{"subject":{"type":"string"},"initial_message":{"type":"string"},"reply_by_email":{"type":"boolean"}}},
      "SupportChat.MessageCreate": {"type":"object","required":["chat_id","content"],"properties":{"chat_id":{"type":"integer"},"content":{"type":"string"}}},
      "SupportChat.Message": {"type":"object","properties":{"id":{"type":"integer"},"chat_id":{"type":"integer"},"sender_user_id":{"type":"integer"},"content":{"type":"string"},"timestamp":{"type":"string","format":"date-time"}}},
      "SupportChat.Ticket":{"type":"object","properties":{"id":{"type":"integer"},"user_id":{"type":"integer"},"subject":{"type":"string"},"status":{"type":"string","enum":["open","closed"]},"created_at":{"type":"string","format":"date-time"}}},
      "SupportChat.TicketDetail":{"allOf":[{"$ref":"#/components/schemas/SupportChat.Ticket"},{"type":"object","properties":{"reply_by_email":{"type":"boolean"},"last_message_at":{"type":"string","format":"date-time"}}}], "status": {"type": "string", "enum": ["open", "closed", "pending"], "description": "Текущий статус тикета"}},
      "Chat.ChatCreate":{"type":"object","required":["class_id"],"properties":{"class_id":{"type":"integer"}}},
      "Chat.Chat":{"type":"object","properties":{"id":{"type":"integer"},"class_id":{"type":"integer"},"created_at":{"type":"string","format":"date-time"}}},
      "Chat.MessageCreate":{"type":"object","required":["content"],"properties":{"content":{"type":"string"}}},
      "Chat.Message":{"type":"object","properties":{"id":{"type":"integer"},"chat_id":{"type":"integer"},"sender_user_id":{"type":"integer"},"content":{"type":"string"},"timestamp":{"type":"string","format":"date-time"}}}
    }
  }
}

    