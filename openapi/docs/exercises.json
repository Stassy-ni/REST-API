{
  "openapi": "3.0.3",
  "info": {
    "title": "Math Learning Platform API",
    "version": "1.0.0",
    "description": "Спецификация REST API для модуля банка заданий и теоретического блока."
  },
  "servers": [
    {
      "url": "https://api.mathplatform.example.com/v1",
      "description": "Production"
    }
  ],
  "tags": [
    {
      "name": "TaskBank - Карточки заданий",
      "description": "Управление карточками заданий: создание, редактирование, просмотр, модерация"
    },
    {
      "name": "TaskBank - Задачи (exercises)",
      "description": "Управление отдельными задачами внутри карточек: создание, генерация, просмотр"
    },
    {
      "name": "TaskBank - Теория",
      "description": "Работа с теоретическим материалом по темам"
    },
    {
      "name": "TaskBank - Тренажёр",
      "description": "Генерация и получение ИИ-наборов упражнений по теме"
    },
    {
      "name": "Reference - Темы и разделы",
      "description": "Справочники: список тем и разделов, связанных с предметами и параллелями"
    }
  ],
  "externalDocs": {
    "description": "Swagger UI / Redoc",
    "url": "https://api.mathplatform.example.com/docs"
  },
  "paths": {
    "/sections": {
      "get": {
        "tags": ["Reference - Темы и разделы"],
        "summary": "Получить список разделов",
        "description": "Возвращает список всех доступных разделов по предметам и параллелям (классам).",
        "security": [{"BearerAuth": []}],
        "parameters": [
          {
            "name": "subject",
            "in": "query",
            "schema": { "type": "string" },
            "description": "Фильтрация по предмету (например, 'алгебра', 'геометрия')"
          },
          {
            "name": "grade",
            "in": "query",
            "schema": { "type": "integer" },
            "description": "Фильтрация по параллели (класс)"
          }
        ],
        "responses": {
          "200": {
            "description": "Список разделов",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/Reference.Section" }
                }
              }
            }
          }
        }
      }
    },

    "/topics": {
      "get": {
        "tags": ["Reference - Темы и разделы"],
        "summary": "Получить список тем",
        "description": "Возвращает темы, сгруппированные по разделам. Поддерживает фильтрацию по предмету, разделу, классу и поиску.",
        "security": [{"BearerAuth": []}],
        "parameters": [
          { "name": "section_id", "in": "query", "schema": { "type": "integer" }, "description": "Фильтрация по ID раздела" },
          { "name": "subject", "in": "query", "schema": { "type": "string" }, "description": "Фильтрация по предмету" },
          { "name": "grade", "in": "query", "schema": { "type": "integer" }, "description": "Фильтрация по параллели (класс)" },
          { "name": "search", "in": "query", "schema": { "type": "string" }, "description": "Поиск по названию темы" }
        ],
        "responses": {
          "200": {
            "description": "Список тем",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/Reference.Topic" }
                }
              }
            }
          }
        }
      }
    },
    "/exercises": {
      "get": {
        "tags": ["TaskBank - Задания"],
        "summary": "Получить задачи из карточки или темы",
        "description": "Позволяет получить список заданий, отфильтрованных по карточке, теме, уровню сложности и типу.",
        "security": [{"BearerAuth": []}],
        "parameters": [
          { "name": "exercise_card_id", "in": "query", "schema": { "type": "integer" }, "description": "ID карточки заданий" },
          { "name": "topic_id", "in": "query", "schema": { "type": "integer" }, "description": "ID темы" },
          { "name": "difficulty", "in": "query", "schema": { "type": "string", "enum": ["easy", "medium", "hard"] }, "description": "Фильтр по уровню сложности" },
          { "name": "type", "in": "query", "schema": { "type": "string", "enum": ["multiple-choice", "open-ended"] }, "description": "Тип задания" }
        ],
        "responses": {
          "200": {
            "description": "Список заданий",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/TaskBank.Exercise" }
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["TaskBank - Задания"],
        "summary": "Создать задачу вручную или через ИИ",
        "description": "Создаёт новое задание, связанное с карточкой заданий. Можно указать, что задача сгенерирована ИИ.",
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/TaskBank.ExerciseCreate" },
              "example": {
                "exercise_card_id": 22,
                "prompt": "Вычислите: $$\\frac{3}{4} + \\frac{1}{2}$$",
                "answer_key": "\\frac{5}{4}",
                "difficulty": "easy",
                "is_ai_generated": true
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Задание создано",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/TaskBank.Exercise" }
              }
            }
          },
          "400": { "description": "Ошибка валидации" }
        }
      }
    },
    "/exercise-cards": {
      "get": {
        "tags": ["TaskBank - Карточки заданий"],
        "summary": "Получить карточки заданий",
        "description": "Возвращает карточки заданий, отфильтрованные по теме, сложности, типу, статусу и владельцу.",
        "security": [{"BearerAuth": []}],
        "parameters": [
          { "name": "topic_id", "in": "query", "schema": { "type": "integer" }, "description": "Фильтрация по ID темы" },
          { "name": "difficulty", "in": "query", "schema": { "type": "string", "enum": ["easy", "medium", "hard"] }, "description": "Фильтрация по уровню сложности" },
          { "name": "type", "in": "query", "schema": { "type": "string", "enum": ["multiple-choice", "open-ended"] }, "description": "Тип задач в карточке" },
          { "name": "status", "in": "query", "schema": { "type": "string" }, "description": "Фильтрация по статусу карточки (например, 'published')" },
          { "name": "owner", "in": "query", "schema": { "type": "string", "enum": ["me", "global"] }, "description": "Показывать свои или глобальные карточки" },
          { "name": "search", "in": "query", "schema": { "type": "string" }, "description": "Поиск по названию карточки" }
        ],
        "responses": {
          "200": {
            "description": "Список карточек",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/TaskBank.ExerciseCard" }
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["TaskBank - Карточки заданий"],
        "summary": "Создать новую карточку заданий",
        "description": "Эксперты создают глобальные карточки, учителя — личные. Указывается тема, владелец и тип.",
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/TaskBank.ExerciseCardCreate" },
              "example": {
                "topic_id": 7,
                "title": "Деление дробей",
                "description": "Задания для закрепления темы",
                "owner_type": "teacher",
                "teacher_profile_id": 42
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Карточка создана",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/TaskBank.ExerciseCard" }
              }
            }
          },
          "400": { "description": "Ошибка валидации" }
        }
      }
    },
    "/exercise-cards/{exercise_card_id}": {
      "patch": {
        "tags": ["TaskBank - Карточки заданий"],
        "summary": "Обновить карточку заданий",
        "description": "Только владелец может редактировать черновик карточки до публикации или назначения.",
        "security": [{"BearerAuth": []}],
        "parameters": [
          { "name": "exercise_card_id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/TaskBank.ExerciseCardUpdate" },
              "example": {
                "title": "Обновлённая тема",
                "description": "Дополнительные задачи"
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Карточка обновлена" },
          "403": { "description": "Нет прав или карточка уже опубликована" },
          "404": { "description": "Карточка не найдена" }
        }
      },
      "delete": {
        "tags": ["TaskBank - Карточки заданий"],
        "summary": "Удалить карточку заданий",
        "description": "Удаляет карточку, если она не была опубликована или назначена. Только владелец.",
        "security": [{"BearerAuth": []}],
        "parameters": [
          { "name": "exercise_card_id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": {
          "204": { "description": "Карточка удалена" },
          "403": { "description": "Нет прав или карточка назначена" },
          "404": { "description": "Карточка не найдена" }
        }
      }
    },
    "/exercise-cards/ai-generate": {
      "post": {
        "tags": ["TaskBank - Карточки заданий"],
        "summary": "Генерировать карточку ИИ по теме и сложности",
        "description": "Учитель может сгенерировать шаблон карточки с задачами автоматически, если в банке достаточно упражнений по теме.",
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/TaskBank.AIExerciseCardGenerate" },
              "example": {
                "topic_id": 7,
                "difficulty": "medium",
                "count": 5
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Сгенерирована карточка ИИ",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/TaskBank.ExerciseCard" }
              }
            }
          },
          "400": { "description": "Недостаточно задач для генерации" }
        }
      }
    },
    "/card-submissions": {
      "post": {
        "tags": ["TaskBank - Карточки заданий"],
        "summary": "Предложение своей карточки на модерацию",
        "description": "Учитель отправляет карточку на проверку (статус pending).",
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/TaskBank.CardSubmissionCreate" },
              "example": {
                "exercise_card_id": 42
              }
            }
          }
        },
        "responses": {
          "201": { "description": "Заявка на модерацию создана" },
          "400": { "description": "Неверные данные или отправлена ранее" }
        }
      },
      "get": {
        "tags": ["TaskBank - Карточки заданий"],
        "summary": "Просмотр предложений на модерацию",
        "description": "Эксперты и админы могут фильтровать заявки по статусу и дате.",
        "security": [{"BearerAuth": []}],
        "parameters": [
          { "name": "status", "in": "query", "schema": { "type": "string", "enum": ["pending", "approved", "rejected"] } },
          { "name": "created_after", "in": "query", "schema": { "type": "string", "format": "date-time" } },
          { "name": "created_before", "in": "query", "schema": { "type": "string", "format": "date-time" } }
        ],
        "responses": {
          "200": {
            "description": "Список заявок на модерацию",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/TaskBank.CardSubmission" }
                }
              }
            }
          },
          "403": { "description": "Нет доступа" }
        }
      }
    },
    "/card-submissions/{submission_id}": {
      "patch": {
        "tags": ["TaskBank - Карточки заданий"],
        "summary": "Принять или отклонить карточку",
        "description": "Админ подтверждает или отклоняет предложенную учителем карточку.",
        "security": [{"BearerAuth": []}],
        "parameters": [
          { "name": "submission_id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/TaskBank.CardSubmissionUpdate" },
              "example": {
                "status": "approved",
                "review_comment": "Хорошая подборка"
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Заявка обновлена" },
          "403": { "description": "Нет прав" },
          "404": { "description": "Заявка не найдена" }
        }
      }
    },
    "/theory": {
      "post": {
        "tags": ["TaskBank - Теория"],
        "summary": "Создание теоретического материала по теме",
        "description": "Эксперт добавляет теоретический материал, связанный с темой.",
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/TaskBank.TheoryCreate" },
              "example": {
                "topic_id": 12,
                "content": "Теория о делении дробей...",
                "order": 1,
                "version": 1,
                "valid_from": "2025-01-01T00:00:00Z"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Теория успешно создана"
          },
          "400": { "description": "Ошибка валидации" }
        }
      },
      "get": {
        "tags": ["TaskBank - Теория"],
        "summary": "Получение теоретического материала",
        "description": "Учитель и ученик могут прочитать теорию по указанной теме.",
        "security": [{"BearerAuth": []}],
        "parameters": [
          { "name": "topic_id", "in": "query", "schema": { "type": "integer" }, "description": "Фильтрация по теме" }
        ],
        "responses": {
          "200": {
            "description": "Список теоретических материалов",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/TaskBank.TheoryMaterial" }
                }
              }
            }
          },
          "403": { "description": "Нет доступа" }
        }
      }
    },
    "/trainer-exercises": {
      "post": {
        "tags": ["TaskBank - Тренажёр"],
        "summary": "Сгенерировать тренажёр по теме и сложности",
        "description": "Ученик генерирует набор задач для самостоятельной работы.",
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/TaskBank.TrainerGenerate" },
              "example": {
                "topic_id": 12,
                "difficulty": "medium",
                "count": 10
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Сгенерирован тренажёр (task set)",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/TaskBank.TrainerTaskSetDetail" }
              }
            }
          },
          "400": { "description": "Ошибка валидации" }
        }
      },
      "get": {
        "tags": ["TaskBank - Тренажёр"],
        "summary": "Получить тренировочный набор по теме и сложности",
        "description": "Возвращает последний активный набор задач для ученика по заданным параметрам.",
        "security": [{"BearerAuth": []}],
        "parameters": [
          { "name": "topic_id", "in": "query", "schema": { "type": "integer" } },
          { "name": "difficulty", "in": "query", "schema": { "type": "string", "enum": ["easy","medium","hard"] } }
        ],
        "responses": {
          "200": {
            "description": "Тренажёр найден",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/TaskBank.TrainerTaskSetDetail" }
              }
            }
          },
          "404": { "description": "Тренажёр не найден" }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT"
      }
    },
    "schemas": {
      "Reference.Section": {"type":"object","properties":{"id":{"type":"integer","example":1},"subject":{"type":"string","example":"математика"},"grade_range":{"type":"string","example":"5-9"},"title":{"type":"string","example":"Арифметика"}}},
      "Reference.Topic": {"type":"object","properties":{"id":{"type":"integer","example":12},"section_id":{"type":"integer","example":1},"title":{"type":"string","example":"Деление дробей"},"description":{"type":"string","example":"Изучение деления обыкновенных и десятичных дробей"},"grade_level":{"type":"integer","example":6}}},
      "TaskBank.Exercise": {"type":"object","properties":{"id":{"type":"integer","example":101},"exercise_card_id":{"type":"integer","example":22},"prompt":{"type":"string","example":"Найдите значение: $$\\frac{1}{2} + \\frac{1}{4}$$"},"answer_key":{"type":"string","example":"\\frac{3}{4}"},"difficulty":{"type":"string","enum":["easy","medium","hard"],"example":"easy"},"is_ai_generated":{"type":"boolean","example":true},"created_at":{"type":"string","format":"date-time","example":"2025-06-20T14:00:00Z"},"changed_at":{"type":"string","format":"date-time","example":"2025-06-21T09:00:00Z"}}},
      "TaskBank.ExerciseCreate": {"type":"object","required":["exercise_card_id","prompt","answer_key"],"properties":{"exercise_card_id":{"type":"integer"},"prompt":{"type":"string"},"answer_key":{"type":"string"},"difficulty":{"type":"string","enum":["easy","medium","hard"]},"is_ai_generated":{"type":"boolean"}}},
      "TaskBank.ExerciseCard": {"type":"object","properties":{"id":{"type":"integer","example":12},"topic_id":{"type":"integer","example":7},"title":{"type":"string","example":"Сложение дробей"},"description":{"type":"string","example":"Карточка для закрепления темы"},"owner_type":{"type":"string","enum":["expert","teacher"],"example":"teacher"},"expert_profile_id":{"type":["integer","null"],"example":null},"teacher_profile_id":{"type":["integer","null"],"example":42},"status":{"type":"string","example":"draft"},"created_at":{"type":"string","format":"date-time","example":"2025-01-10T10:00:00Z"},"changed_at":{"type":"string","format":"date-time","example":"2025-06-10T15:30:00Z"}},
        "_links": {
          "topic": { "type": "string", "example": "/topics/17" },
          "author": { "type": "string", "example": "/profiles/teacher/42" }}, "status": {"type": "string", "enum": ["draft", "pending", "published", "assigned"], "description": "Статус карточки: draft — черновик, pending — на модерации, published — опубликована, assigned — назначена"}},
      "TaskBank.ExerciseCardCreate": {"type":"object","required":["topic_id","title","owner_type"],"properties":{"topic_id":{"type":"integer"},"title":{"type":"string"},"description":{"type":"string"},"owner_type":{"type":"string","enum":["teacher","expert"]},"expert_profile_id":{"type":["integer","null"]},"teacher_profile_id":{"type":["integer","null"]}}},
      "TaskBank.ExerciseCardUpdate": {"type":"object","properties":{"title":{"type":"string"},"description":{"type":"string"}}},
      "TaskBank.AIExerciseCardGenerate": {"type":"object","required":["topic_id","difficulty","count"],"properties":{"topic_id":{"type":"integer"},"difficulty":{"type":"string","enum":["easy","medium","hard"]},"count":{"type":"integer","example":5}}},
      "TaskBank.CardSubmissionCreate": {"type":"object","required":["exercise_card_id"],"properties":{"exercise_card_id":{"type":"integer"}}},
      "TaskBank.CardSubmission": {"type":"object","properties":{"id":{"type":"integer","example":15},"exercise_card_id":{"type":"integer","example":42},"teacher_profile_id":{"type":"integer","example":10},"status":{"type":"string","enum":["pending","approved","rejected"],"example":"pending"},"reviewed_by_admin_id":{"type":["integer","null"],"example":null},"created_at":{"type":"string","format":"date-time","example":"2025-06-20T12:00:00Z"},"review_comment":{"type":"string","example":"Добавить больше примеров"},"reviewed_at":{"type":["string","null"],"format":"date-time","example":null}},"TaskBank.CardSubmissionUpdate":{"type":"object","required":["status"],"properties":{"status":{"type":"string","enum":["approved","rejected"]},"review_comment":{"type":"string"}}}},
      "TaskBank.TheoryCreate": {"type":"object","required":["topic_id","content","order","version","valid_from"],"properties":{"topic_id":{"type":"integer"},"content":{"type":"string"},"order":{"type":"integer"},"version":{"type":"integer"},"valid_from":{"type":"string","format":"date-time"},"valid_until":{"type":["string","null"],"format":"date-time"},"is_current":{"type":"boolean","example":true}}},
      "TaskBank.TheoryMaterial": {"type":"object","properties":{"id":{"type":"integer","example":5},"topic_id":{"type":"integer","example":12},"content":{"type":"string","example":"Теория..."},"order":{"type":"integer","example":1},"version":{"type":"integer","example":1},"is_current":{"type":"boolean","example":true},"valid_from":{"type":"string","format":"date-time","example":"2025-01-01T00:00:00Z"},"valid_until":{"type":["string","null"],"format":"date-time","example":null},"updated_by_user_id":{"type":"integer","example":2},"changed_at":{"type":"string","format":"date-time","example":"2025-06-20T14:00:00Z"}}},
      "TaskBank.TrainerGenerate": {"type":"object","required":["topic_id","difficulty","count"],"properties":{"topic_id":{"type":"integer"},"difficulty":{"type":"string","enum":["easy","medium","hard"]},"count":{"type":"integer","example":10}}},
      "TaskBank.TrainerTaskSetDetail": {"type":"object","properties":{"id":{"type":"integer","example":100},"user_id":{"type":"integer","example":50},"topic_id":{"type":"integer","example":12},"difficulty":{"type":"string","enum":["easy","medium","hard"],"example":"medium"},"generated_at":{"type":"string","format":"date-time","example":"2025-06-21T11:00:00Z"},"expires_at":{"type":"string","format":"date-time","example":"2025-07-21T11:00:00Z"},"exercises":{"type":"array","items":{"type":"object","properties":{"exercise_id":{"type":"integer"},"prompt":{"type":"string"},"answer_key":{"type":"string"},"position":{"type":"integer"}}}}}}
    }
  }
}

  
