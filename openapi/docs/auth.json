{
  "openapi": "3.0.3",
  "info": {
    "title": "Math Learning Platform API",
    "version": "1.0.0",
    "description": "Спецификация REST API для модуля аутентификации и управления доступом."
  },
  "servers": [
    {
      "url": "https://api.mathplatform.example.com/v1",
      "description": "Production"
    }
  ],
  "tags": [
    {"name":"Auth","description":"Регистрация, вход, выход, управление заявками"}
  ],
  "paths": {
    "/auth/register": {
      "post": {
        "tags":["Auth"],
        "summary":"Регистрация нового пользователя",
        "security":[],
        "responses":{
          "201":{"description":"Created","content":{"application/json":{"schema":{"$ref":"#/components/schemas/Auth.AuthTokenResponse"}}}},
          "400":{"description":"Validation error or duplicate email or forbidden role"},
          "429":{"description":"Rate limit or CAPTCHA required"}
        },
        "requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/Auth.RegisterRequest"},"example":{"email":"teacher@example.com","password":"Pass!234","role":"teacher"}}}}
      }
    },
    "/auth/login": {
      "post": {
        "tags":["Auth"],
        "summary":"Аутентификация пользователя",
        "security":[],
        "responses":{
          "200":{"description":"OK","content":{"application/json":{"schema":{"$ref":"#/components/schemas/Auth.AuthTokenResponse"}}}},
          "401":{"description":"Invalid credentials or inactive user"},
          "429":{"description":"Too many attempts"}
        },
        "requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/Auth.LoginRequest"},"example":{"email":"user@ex.com","password":"Pass!234"}}}}
      }
    },
    "/auth/refresh": {
      "post": {
        "tags":["Auth"],
        "summary":"Обновление access-токена",
        "security":[{"BearerAuth":[]}],
        "responses":{
          "200":{"description":"New access token","content":{"application/json":{"schema":{"$ref":"#/components/schemas/Auth.AccessResponse"}}}},
          "401":{"description":"Invalid or expired refresh token"}
        },
        "requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/Auth.RefreshRequest"},"example":{"refresh":"eyJhbGci..."}}}}
      }
    },
    "/auth/logout": {
      "post": {
        "tags":["Auth"],
        "summary":"Выход (@invalidate refresh token)",
        "security":[{"BearerAuth":[]}],
        "responses":{
          "204":{"description":"Logged out"},
          "401":{"description":"Invalid token"}
        }
      }
    },
    "/auth/forgot-password": {
      "post": {
        "tags":["Auth"],
        "summary":"Запрос восстановления пароля",
        "security":[],
        "responses":{
          "200":{"description":"If email exists, email will be sent"},
          "400":{"description":"Bad request"},
          "429":{"description":"Too many requests"}
        },
        "requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/Auth.ForgotPasswordRequest"},"example":{"email":"user@ex.com"}}}}
      }
    },
    "/auth/reset-password": {
      "post": {
        "tags":["Auth"],
        "summary":"Сброс пароля по токену",
        "security":[],
        "responses":{
          "200":{"description":"Password reset successful"},
          "400":{"description":"Invalid or expired token"}
        },
        "requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/Auth.ResetPasswordRequest"},"example":{"token":"securetoken","new_password":"New!234"}}}}
      }
    },
    "/auth/me": {
      "get": {
        "tags":["Auth"],
        "summary":"Получение текущей учётки",
        "security":[{"BearerAuth":[]}],
        "responses":{
          "200":{"description":"User data","content":{"application/json":{"schema":{"$ref":"#/components/schemas/Auth.User"}}}},
          "401":{"description":"Unauthorized or invalid token"}
        }
      }
    },
    "/auth/change-password": {
      "post": {
        "tags":["Auth"],
        "summary":"Смена пароля авторизованным пользователем",
        "security":[{"BearerAuth":[]}],
        "responses":{
          "200":{"description":"Password changed"},
          "400":{"description":"Wrong old password"},
          "429":{"description":"Too frequent changes"}
        },
        "requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/Auth.ChangePasswordRequest"},"example":{"old_password":"Old!234","new_password":"New!456"}}}}
      }
    },
    "/auth/access-request/{id}": {
      "delete": {
        "tags":["Auth"],
        "summary":"Отмена заявки на доступ",
        "security":[{"BearerAuth":[]}],
        "parameters":[{"name":"id","in":"path","schema":{"type":"integer"},"required":true}],
        "responses":{
          "204":{"description":"Cancelled"},
          "403":{"description":"Not author or already processed"},
          "404":{"description":"Not found"}
        }
      }
    },
    "/auth/access-requests": {
      "get": {
        "tags":["Auth"],
        "summary":"Просмотр заявок (Admin only)",
        "security":[{"BearerAuth":[]}],
        "parameters":[
          {"name":"status","in":"query","schema":{"type":"string","enum":["pending","approved","declined"]}},
          {"name":"role_id","in":"query","schema":{"type":"integer"}},
          {"name":"email","in":"query","schema":{"type":"string"}},
          {"name":"created_after","in":"query","schema":{"type":"string","format":"date"}},
          {"name":"ordering","in":"query","schema":{"type":"string"}}
        ],
        "responses":{
          "200":{"description":"List of access requests","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/Auth.AccessRequest"}}}}},
          "403":{"description":"Forbidden"}
        }
      }
    },
    "/auth/access-requests/{access_request_id}": {
      "patch": {
        "tags":["Auth"],
        "summary":"Модерация заявки (approve/decline)",
        "security":[{"BearerAuth":[]}],
        "parameters":[{"name":"access_request_id","in":"path","schema":{"type":"integer"},"required":true}],
        "requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/Auth.AccessRequestModeration"},"example":{"status":"approved"}}}},
        "responses":{
          "200":{"description":"Updated request","content":{"application/json":{"schema":{"$ref":"#/components/schemas/Auth.AccessRequest"}}}},
          "400":{"description":"Already processed or bad status"},
          "403":{"description":"Forbidden"}
        }
      }
    }
  },
  "components": {
    "securitySchemes":{
      "BearerAuth":{"type":"http","scheme":"bearer","bearerFormat":"JWT"}
    },
    "schemas":{
      "Auth.RegisterRequest":{"type":"object","required":["email","password","role"],"properties":{"email":{"type":"string","format":"email"},"password":{"type":"string"},"role":{"type":"string","enum":["teacher","expert","student"]}}},
      "Auth.LoginRequest":{"type":"object","required":["email","password"],"properties":{"email":{"type":"string","format":"email"},"password":{"type":"string"}}},
      "Auth.RefreshRequest":{"type":"object","required":["refresh"],"properties":{"refresh":{"type":"string"}}},
      "Auth.ForgotPasswordRequest":{"type":"object","required":["email"],"properties":{"email":{"type":"string","format":"email"}}},
      "Auth.ResetPasswordRequest":{"type":"object","required":["token","new_password"],"properties":{"token":{"type":"string"},"new_password":{"type":"string"}}},
      "Auth.ChangePasswordRequest":{"type":"object","required":["old_password","new_password"],"properties":{"old_password":{"type":"string"},"new_password":{"type":"string"}}},
      "Auth.AuthTokenResponse":{"type":"object","properties":{"access":{"type":"string"},"refresh":{"type":"string"}}},
      "Auth.AccessResponse":{"type":"object","properties":{"access":{"type":"string"}}},
      "Auth.User":{"type":"object","properties":{"id":{"type":"integer"},"email":{"type":"string","format":"email"},"role":{"type":"string"}}},
      "Auth.AccessRequest":{"type":"object","properties":{"id":{"type":"integer"},"user_id":{"type":"integer"},"email":{"type":"string"},"requested_role_id":{"type":"integer"},"status":{"type":"string"},"created_at":{"type":"string","format":"date-time"}}},
      "Auth.AccessRequestModeration":{"type":"object","required":["status"],"properties":{"status":{"type":"string","enum":["approved","declined"]}}}
    }
  }
}
