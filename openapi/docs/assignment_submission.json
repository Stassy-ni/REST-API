{
  "openapi": "3.0.3",
  "info": {
    "title": "Math Learning Platform API",
    "version": "1.0.0",
    "description": "Спецификация REST API для модуля выдачи и аналитики заданий."
  },
  "servers": [
    {
      "url": "https://api.mathplatform.example.com/v1",
      "description": "Production"
    }
  ],
  "tags": [
    { "name": "Assignment", "description": "Выдача, редактирование и удаление заданий для классов" },
    { "name": "Submission", "description": "Ответы учеников: отправка, просмотры, ограничения" },
    { "name": "Assignment Analytics", "description": "Аналитика: фильтрация ответов и статусов по студентам" }
  ],
  "externalDocs": {
    "description": "Swagger UI / Redoc",
    "url": "https://api.mathplatform.example.com/docs"
  },
  "paths": {
    "/assignment-tasks": {
      "post": {
        "tags": ["Assignment"],
        "summary": "Выдать задание классу или ученикам",
        "security": [{"BearerAuth": []}],
        "description": "Учитель создаёт задание для класса или конкретных учеников. Проверяется принадлежность и дедлайн, пересечения.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/Assignment.Create" },
              "example": {
                "exercise_card_id": 42,
                "class_id": 7,
                "student_ids": [101,102],
                "assigned_at": "2025-06-21T10:00:00Z",
                "due_date": "2025-06-25T23:59:59Z"
              }
            }
          }
        },
        "responses": {
          "201": { "description": "Задание выдано" },
          "403": { "description": "Нет доступа или дедлайн пересечён" },
          "400": { "description": "Ошибка валидации" }
        }
      },
      "get": {
        "tags": ["Assignment"],
        "summary": "Список заданий",
        "security": [{"BearerAuth": []}],
        "description": "Выдаёт список заданий с фильтрами и пагинацией.",
        "parameters": [
          { "name": "class_id", "in": "query", "schema": { "type": "integer" } },
          { "name": "status", "in": "query", "schema": { "type": "string", "enum": ["active","archived"] } },
          { "name": "due_before", "in": "query", "schema": { "type": "string", "format": "date-time" } },
          { "name": "topic_id", "in": "query", "schema": { "type": "integer" } },
          { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 20 } },
          { "name": "offset", "in": "query", "schema": { "type": "integer", "default": 0 } }
        ],
        "responses": {
          "200": {
            "description": "Список заданий",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "count": { "type": "integer" },
                    "next": { "type": "string", "format": "uri", "nullable": true },
                    "previous": { "type": "string", "format": "uri", "nullable": true },
                    "results": { "type": "array", "items": { "$ref": "#/components/schemas/Assignment.Task" } }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/assignment-tasks/{assignment_id}": {
      "get": {
        "tags": ["Assignment"],
        "summary": "Детали задания",
        "security": [{"BearerAuth": []}],
        "parameters": [
          { "name": "assignment_id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": {
          "200": {
            "description": "Информация о задании",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Assignment.TaskDetail" } } }
          },
          "403": { "description": "Нет доступа" },
          "404": { "description": "Задание не найдено" }
        }
      },
      "patch": {
        "tags": ["Assignment"],
        "summary": "Изменить параметры задания",
        "security": [{"BearerAuth": []}],
        "parameters": [
          { "name": "assignment_id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "requestBody": {
          "required": true,
          "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Assignment.Update" } } }
        },
        "responses": {
          "200": { "description": "Задание обновлено" },
          "403": { "description": "Нет доступа" },
          "404": { "description": "Не найдено" }
        }
      },
      "delete": {
        "tags": ["Assignment"],
        "summary": "Удалить задание",
        "security": [{"BearerAuth": []}],
        "parameters": [
          { "name": "assignment_id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": {
          "204": { "description": "Задание удалено" },
          "403": { "description": "Нет прав или есть сабмишены" },
          "404": { "description": "Не найдено" },
          "409": { "description": "Задание имеет ответы" }
        }
      }
    },
    "/task-submissions": {
      "get": {
        "tags": ["Submission","Assignment Analytics"],
        "summary": "Просмотр ответов",
        "security": [{"BearerAuth": []}],
        "parameters": [
          { "name": "student_id", "in": "query", "schema": { "type": "integer" } },
          { "name": "assignment_id", "in": "query", "schema": { "type": "integer" } },
          { "name": "limit", "in": "query", "schema": { "type": "integer", "default": 20 } },
          { "name": "offset", "in": "query", "schema": { "type": "integer", "default": 0 } }
        ],
        "responses": {
          "200": {
            "description": "Список сабмишенов",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "count": { "type": "integer" },
                    "next": { "type": "string", "format": "uri", "nullable": true },
                    "previous": { "type": "string", "format": "uri", "nullable": true },
                    "results": { "type": "array", "items": { "$ref": "#/components/schemas/Submission.TaskSubmission" } }
                  }
                }
              }
            }
          }
        }
      },
      "post": {
        "tags": ["Submission"],
        "summary": "Отправить решение на задание",
        "security": [{"BearerAuth": []}],
        "requestBody": {
          "required": true,
          "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Submission.Create" } } }
        },
        "responses": {
          "201": { "description": "Ответ принят" },
          "403": { "description": "После дедлайна запрещено" },
          "409": { "description": "Превышен лимит попыток" },
          "400": { "description": "Некорректные данные" }
        }
      }
    },
    "/assignment-tasks/{assignment_id}/task-submissions": {
      "post": {
        "tags": ["Submission"],
        "summary": "Отправить решение на задание",
        "security": [{"BearerAuth": []}],
        "parameters": [
          {
            "name": "assignment_id",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/Submission.Create" },
              "example": {
                "student_profile_id": 123,
                "answers": [
                  { "exercise_id": 56, "student_answer": "x = 4", "attempt_number": 1 }
                ]
              }
            }
          }
        },
        "responses": {
          "201": { "description": "Ответ успешно отправлен" },
          "403": { "description": "Просрочено или нет доступа" },
          "409": { "description": "Превышен лимит попыток" },
          "400": { "description": "Неверные данные" }
        }
      }
    },
    "/task-submissions/{submission_id}": {
      "get": {
        "tags": ["Submission"],
        "summary": "Просмотр отправленного решения",
        "security": [{"BearerAuth": []}],
        "parameters": [
          {
            "name": "submission_id",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" }
          }
        ],
        "responses": {
          "200": {
            "description": "Детали ответа",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Submission.TaskSubmissionDetail" }
              }
            }
          },
          "403": { "description": "Доступ запрещён" },
          "404": { "description": "Не найдено" }
        }
      },
      "patch": {
        "tags": ["Submission"],
        "summary": "Повторная попытка",
        "security": [{"BearerAuth": []}],
        "parameters": [
          {
            "name": "submission_id",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/Submission.Retry" },
              "example": {
                "answers": [
                  { "exercise_id": 56, "student_answer": "x = 5", "attempt_number": 2 }
                ]
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Ответ обновлён" },
          "403": { "description": "Превышен лимит или дедлайн" },
          "409": { "description": "Нельзя редактировать чужой ответ" },
          "404": { "description": "Ответ не найден" }
        }
      },
      "delete": {
        "tags": ["Submission"],
        "summary": "Отмена отправки (soft delete)",
        "security": [{"BearerAuth": []}],
        "parameters": [
          {
            "name": "submission_id",
            "in": "path",
            "required": true,
            "schema": { "type": "integer" }
          }
        ],
        "responses": {
          "204": { "description": "Ответ удалён (soft delete)" },
          "403": { "description": "Нет доступа или поздно" },
          "404": { "description": "Не найдено" }
        }
      }
    },
    "/assignment-tasks-analytics/{assignment_id}/task-submissions": {
      "get": {
        "tags": ["Assignment Analytics"],
        "summary": "Результаты по заданию",
        "security": [{"BearerAuth": []}],
        "parameters": [
          { "name": "assignment_id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": {
          "200": {
            "description": "Список результатов по ученикам",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/Analytics.SubmissionAnalytics" }
                }
              }
            }
          },
          "403": { "description": "Нет доступа — только для своих классов" },
          "404": { "description": "Задание не найдено" }
        }
      }
    },
    "/assignment-tasks-analytics/{assignment_id}/histogram": {
      "get": {
        "tags": ["Assignment Analytics"],
        "summary": "Гистограмма точности и времени выполнения",
        "security": [{"BearerAuth": []}],
        "parameters": [
          { "name": "assignment_id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": {
          "200": {
            "description": "Гистограмма распределения результатов",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Analytics.Histogram" }
              }
            }
          },
          "403": { "description": "Нет доступа — только для своих классов" },
          "404": { "description": "Задание не найдено" }
        }
      }
    },
    "/assignment-tasks-analytics/class/{class_id}": {
      "get": {
        "tags": ["Assignment Analytics"],
        "summary": "Сводная аналитика по классу",
        "security": [{"BearerAuth": []}],
        "parameters": [
          { "name": "class_id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": {
          "200": {
            "description": "Документ аналитики по классу",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Analytics.ClassSummary" }
              }
            }
          },
          "403": { "description": "Нет доступа — только для своих классов" },
          "404": { "description": "Класс не найден" }
        }
      }
    },
    "/assignment-tasks-analytics/student/{student_id}": {
      "get": {
        "tags": ["Assignment Analytics"],
        "summary": "Аналитика по ученику",
        "security": [{"BearerAuth": []}],
        "parameters": [
          { "name": "student_id", "in": "path", "required": true, "schema": { "type": "integer" } }
        ],
        "responses": {
          "200": {
            "description": "Аналитика по ученику",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Analytics.StudentSummary" }
              }
            }
          },
          "403": { "description": "Нет доступа — ученик не в классе учителя" },
          "404": { "description": "Не найдено" }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {"BearerAuth": {"type": "http", "scheme": "bearer", "bearerFormat": "JWT"}
    },
    "schemas": {
      "Assignment.Create": {"type":"object","required":["exercise_card_id","class_id","due_date"],"properties":{"exercise_card_id":{"type":"integer"},"class_id":{"type":"integer"},"student_ids":{"type":"array","items":{"type":"integer"}},"assigned_at":{"type":"string","format":"date-time"},"due_date":{"type":"string","format":"date-time"}}},
      "Assignment.Task": {"type":"object","properties":{"id":{"type":"integer","example":55},"exercise_card_id":{"type":"integer","example":42},"class_id":{"type":"integer","example":7},"assigned_at":{"type":"string","format":"date-time","example":"2025-06-21T10:00:00Z"},"due_date":{"type":"string","format":"date-time","example":"2025-06-25T23:59:59Z"},"status":{"type":"string","enum":["active","archived"],"example":"active"}}},
      "Assignment.TaskDetail": {"allOf":[{"$ref":"#/components/schemas/Assignment.Task"},{"type":"object","properties":{"student_ids":{"type":"array","items":{"type":"integer"}},"responses_count":{"type":"integer","example":3}}}],
        "_links": {
          "exercise_card": { "type": "string", "example": "/exercise-cards/12" },
          "class": { "type": "string", "example": "/classes/3" },
          "submissions": { "type": "string", "example": "/assignment-tasks/10/task-submissions" }}},
      "Assignment.Update": {"type":"object","properties":{"due_date":{"type":"string","format":"date-time"},"student_ids":{"type":"array","items":{"type":"integer"}}}},
      "Submission.Create": {"type":"object","required":["assignment_task_id","student_profile_id","answers"],"properties":{"assignment_task_id":{"type":"integer"},"student_profile_id":{"type":"integer"},"answers":{"type":"array","items":{"type":"object","properties":{"exercise_id":{"type":"integer"},"student_answer":{"type":"string"},"attempt_number":{"type":"integer"}}}}}},
      "Submission.TaskSubmission": {"type":"object","properties":{"id":{"type":"integer","example":123},"assignment_task_id":{"type":"integer"},"student_profile_id":{"type":"integer"},"submitted_at":{"type":"string","format":"date-time","example":"2025-06-22T14:30:00Z"},"attempt_count":{"type":"integer","example":2},"is_completed":{"type":"boolean","example":false}}},
      "Submission.CreateResponse": {"type":"object","properties":{"submission_id":{"type":"integer"},"status":{"type":"string","example":"submitted"}}},
      "Submission.Retry": {"type":"object","required":["answers"],"properties":{"answers":{"type":"array","items":{"type":"object","properties":{"exercise_id":{"type":"integer"},"student_answer":{"type":"string"},"attempt_number":{"type":"integer"}}}}}},
      "Submission.TaskSubmissionDetail": {"type":"object","properties":{"id":{"type":"integer","example":123},"assignment_task_id":{"type":"integer"},"student_profile_id":{"type":"integer"},"submitted_at":{"type":"string","format":"date-time"},"attempt_count":{"type":"integer","example":2},"is_completed":{"type":"boolean"},"answers":{"type":"array","items":{"type":"object","properties":{"exercise_id":{"type":"integer"},"student_answer":{"type":"string"},"is_correct":{"type":"boolean"},"attempt_number":{"type":"integer"},"time_spent":{"type":"integer","description":"Время в секундах"}}}}},
        "_links": {
          "assignment": { "type": "string", "example": "/assignment-tasks/5" },
          "student": { "type": "string", "example": "/profiles/student/7" }}},
      "Analytics.SubmissionAnalytics": {"type":"object","properties":{"student_id":{"type":"integer"},"full_name":{"type":"string"},"attempt_count":{"type":"integer"},"time_spent_avg":{"type":"number"},"correctness_avg":{"type":"number"}}},
      "Analytics.Histogram": {"type":"object","properties":{"time_bins":{"type":"array","items":{"type":"integer"}},"accuracy_bins":{"type":"array","items":{"type":"number"}}}},
      "Analytics.ClassSummary": {"type":"object","properties":{"class_id":{"type":"integer"},"assignments_count":{"type":"integer"},"avg_accuracy":{"type":"number"},"avg_time_spent":{"type":"number"}}},
      "Analytics.StudentSummary": {"type":"object","properties":{"student_id":{"type":"integer"},"assignments_completed":{"type":"integer"},"avg_accuracy":{"type":"number"},"avg_time_spent":{"type":"number"}}}
    }
  }
}

  
